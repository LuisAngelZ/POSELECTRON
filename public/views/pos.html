<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Punto de Venta</title>

  <style>
    /* ===== ESTILOS BASE (SIDEBAR UNIVERSAL) ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: #fafbfc;
      color: #1a1d29;
      overflow-x: hidden;
    }

    /* === APP CONTAINER === */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* === SIDEBAR STYLES === */
    .sidebar-modern {
      width: 280px;
      background: #ffffff;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e8eaed;
      transition: transform 0.3s ease;
    }

    .sidebar-modern.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-header {
      padding: 2rem 1.5rem 1.5rem;
      border-bottom: 1px solid #e8eaed;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: white;
    }

    .brand-text h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1a1d29;
      margin-bottom: 0.25rem;
    }

    .brand-text p {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .user-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: white;
    }

    .user-details h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1a1d29;
      margin-bottom: 0.25rem;
    }

    .user-role {
      font-size: 0.7rem;
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
      font-weight: 500;
    }

    .sidebar-nav {
      padding: 1.5rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 2rem;
      padding: 0 1.5rem;
    }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 1rem;
      padding-left: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      margin-bottom: 0.25rem;
      color: #6b7280;
      text-decoration: none;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      position: relative;
    }

    .nav-item:hover {
      background: #f3f4f6;
      color: #ff7043;
      transform: translateX(4px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #fff3e0, #ffe0b2);
      color: #ff7043;
      box-shadow: 0 2px 8px rgba(255, 112, 67, 0.15);
    }

    .nav-item-icon {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
      margin-right: 1rem;
    }

    .nav-item-text {
      font-weight: 500;
      flex: 1;
    }

    .nav-badge {
      background: #ff7043;
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 1.5rem;
      border-top: 1px solid #e8eaed;
    }

    .logout-btn {
      width: 100%;
      background: #f8f9fa;
      color: #6b7280;
      border: 1px solid #e8eaed;
      padding: 0.875rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      border-color: #fecaca;
    }

    /* === MAIN CONTENT === */
    .main-content {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
      background: #fafbfc;
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    /* === TOP BAR === */
    .top-bar {
      background: white;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sidebar-toggle {
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.6rem;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(255, 112, 67, 0.3);
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1a1d29;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #6b7280;
      font-size: 0.85rem;
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 20px;
    }

    /* === MOBILE STYLES === */
    @media (max-width: 768px) {
      .sidebar-modern {
        width: 260px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar-modern.mobile-open {
        transform: translateX(0);
      }

      .sidebar-modern.collapsed {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0 !important;
      }

      .main-content.expanded {
        margin-left: 0 !important;
      }

      .top-bar {
        padding: 1rem;
      }

      .page-title {
        font-size: 1.25rem;
      }

      .breadcrumb {
        display: none;
      }

      .sidebar-toggle {
        display: none;
      }
    }

    /* === MOBILE MENU BUTTON === */
    .mobile-menu-btn {
      background: linear-gradient(135deg, #ff8a65, #ff7043);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.6rem;
      border-radius: 8px;
      margin-right: 1rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ====== ESTILOS POS ESPEC√çFICOS ====== */
    .pos-content {
      --orange1: #ff8a65;
      --orange2: #ff7043;
      padding: 1.25rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Animaciones POS */
    @keyframes slideInFromTop {
      0% { transform: translateY(-30px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .pos-content {
      animation: slideInFromTop 0.6s both;
    }

    /* Grilla principal */
    .main-grid {
      display: flex;
      gap: 1rem;
      min-height: 600px;
    }

    .left-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }

    .right-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Tarjetas */
    .customer-section,
    .products-section,
    .sales-section-full {
      background: #fff;
      border: 1px solid #e8eaed;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }

    .customer-section {
      height: 220px;
      flex-shrink: 0;
    }

    .products-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sales-section-full {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Headers (naranja) */
    .customer-header,
    .products-header,
    .sales-header {
      background: linear-gradient(135deg, var(--orange1), var(--orange2));
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 0.6rem 0.9rem;
      font-size: 0.86rem;
    }

    /* Formulario cliente */
    .customer-body {
      padding: 0.9rem;
    }

    .customer-form {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr 1fr;
      gap: 0.8rem;
      margin-bottom: 0.7rem;
    }

    .form-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 700;
      color: #555;
      margin-bottom: 0.3rem;
      text-transform: uppercase;
    }

    .form-control {
      width: 100%;
      padding: 0.55rem 0.6rem;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #fff;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--orange2);
      box-shadow: 0 0 0 2px rgba(255, 112, 67, 0.18);
    }

    /* Tabs categor√≠as */
    .products-tabs {
      display: flex;
      gap: 0.5rem;
      background: #f6f7f8;
      padding: 0.5rem 0.6rem;
    }

    .tab-btn {
      border: none;
      border-radius: 14px;
      padding: 0.55rem 1rem;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.78rem;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--orange1), var(--orange2));
      color: #fff;
    }

    /* Grid de productos */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      padding: 1rem;
      flex: 1;
      overflow: auto;
      height: calc(100% - 88px);
    }

    .product-card {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 0.85rem;
      text-align: center;
      background: #fff;
      cursor: pointer;
      transition: 0.2s;
      height: 140px;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .product-image {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--orange1), var(--orange2));
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 0.6rem;
  font-size: 1.25rem;
  overflow: hidden;
  position: relative;
}

.product-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

    .product-name {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .product-price {
      color: #dc3545;
      font-weight: 800;
      margin-top: 0.3rem;
    }

    /* Tabla ventas */
    .sales-body-full {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }

    .sales-table-full {
      flex: 1;
      overflow: auto;
      border: 1px solid #f1f2f4;
      border-radius: 12px;
      background: #fafbfc;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .table th {
      position: sticky;
      top: 0;
      background: #fff7f2;
      color: #333;
      border-bottom: 1px solid #f1f2f4;
      padding: 0.7rem;
    }

    .table td {
      padding: 0.7rem;
      border-bottom: 1px solid #f1f2f4;
      text-align: center;
    }

    /* Totales + pago */
    .totals-payment-section {
      border: 1px solid #eceff3;
      border-radius: 12px;
      background: #fff;
      padding: 1rem;
    }

    .total-main {
      background: #fff;
      border: 1px solid #f1f2f4;
      border-radius: 10px;
      padding: 0.8rem;
      text-align: center;
      margin-bottom: 0.8rem;
    }

    .total-value {
      font-size: 1.8rem;
      color: #28a745;
      font-weight: 800;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      70% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Botones */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 0.7rem;
      font-weight: 800;
      cursor: pointer;
    }

   .btn-success {
  background: linear-gradient(135deg, #ff8a65, #ff7043);
  color: #fff;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.btn-success:hover:not(:disabled) {
  background: linear-gradient(135deg, #ff7043, #f4511e);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 112, 67, 0.4);
}

.btn-secondary {
  background: #ffffff;
  color: #ff7043;
  border: 2px solid #ff7043;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: #ff7043;
  color: #ffffff;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 112, 67, 0.3);
}

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Responsive POS */
    @media (max-width: 1200px) {
      .main-grid {
        flex-direction: column;
      }

      .left-column {
        flex-direction: row;
      }

      .customer-section {
        flex: 1;
      }

      .products-section {
        flex: 1;
      }

      .right-column {
        min-height: 460px;
      }

      .customer-form {
        grid-template-columns: 1fr 1fr;
      }

      .payment-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .pos-content {
        padding: 1rem;
      }

      .customer-form {
        grid-template-columns: 1fr;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }

.payment-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.8rem;
  margin-bottom: 1rem;
}


.payment-item {
  background: linear-gradient(135deg, #f8f9fb, #ffffff);
  border: 2px solid #e8eaed;
  border-radius: 16px;
  padding: 1.2rem;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.payment-item:hover {
  /* Quitar estos efectos exagerados */
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.payment-label {
  font-size: 0.75rem;
  font-weight: 800;
  color: #666;
  text-transform: uppercase;
  margin-bottom: 0.8rem;
  letter-spacing: 0.5px;
}

.payment-value {
  font-weight: 900;
  font-size: 1.4rem;
  margin-bottom: 0.8rem;
  color: #1a1d29;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.payment-input {
  width: 100%;
  padding: 0.8rem;
  border: 2px solid #e1e5e9;
  border-radius: 12px;
  text-align: center;
  font-weight: 700;
  font-size: 1rem;
  background: white;
  transition: all 0.2s ease;
}

.payment-input:focus {
  outline: none;
  border-color: var(--orange2);
  box-shadow: 0 0 0 4px rgba(255, 112, 67, 0.15);
  transform: scale(1.02);
}

.payment-input::placeholder {
  color: #9ca3af;
  font-weight: 500;
}
  </style>
</head>
<body>

  <div class="app-container" id="appContainer">
    <!-- SIDEBAR (ser√° generado por sidebar.js) -->
    
    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">
      <div class="top-bar">
        <div class="top-bar-left">
          <button class="sidebar-toggle" type="button" id="sidebarToggle">
            <span id="toggleIcon">‚ò∞</span>
          </button>
          <h1 class="page-title">üõí Punto de Venta</h1>
        </div>
        <div class="breadcrumb">
          <span>üè†</span>
          <span>Sistema POS</span>
          <span>‚Ä∫</span>
          <span>Punto de Venta</span>
        </div>
      </div>

      <!-- CONTENIDO POS -->
      <div class="pos-content">
        <div class="main-grid">
          <div class="left-column">
            <div class="customer-section">
              <div class="customer-header">üë§ Datos del Cliente</div>
              <div class="customer-body">
                <div class="customer-form">
                  <div class="form-group">
                    <label>CI</label>
                    <input type="text" id="customerNit" class="form-control" value="1234">
                  </div>
                  <div class="form-group">
                    <label>Raz√≥n Social</label>
                    <input type="text" id="customerName" class="form-control" value="SIN NOMBRE">
                  </div>
                  <div class="form-group">
                    <label>Servicio</label>
                    <select id="orderType" class="form-control">
                      <option value="dine_in">En Mesa</option>
                      <option value="takeaway">Para Llevar</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Pago</label>
                    <select id="paymentType" class="form-control">
                      <option value="efectivo">Efectivo</option>
                      <option value="qr">QR</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>Observaciones</label>
                  <textarea id="observations" class="form-control" placeholder="Observaciones..." style="resize:none;height:50px"></textarea>
                </div>
              </div>
            </div>

            <div class="products-section">
              <div class="products-header">üõí Seleccionar Productos</div>
              <div class="products-tabs" id="categoriesNav">
                <button class="tab-btn active" data-category="all">Todos</button>
              </div>
              <div class="products-grid" id="productsGrid">
                <div style="text-align:center;color:#666;padding:1.6rem">Cargando productos...</div>
              </div>
            </div>
          </div>

          <div class="right-column">
            <div class="sales-section-full">
              <div class="sales-header">üìã Detalle de Ventas</div>
              <div class="sales-body-full">
                <div class="sales-table-full">
                  <table class="table">
                    <thead>
                      <tr>
                        <th width="35">Eliminar</th>
                        <th width="50">Producto</th>
                        <th width="70">Precio</th>
                        <th width="60">Cant.</th>
                        <th width="80">Total</th>
                      </tr>
                    </thead>
                    <tbody id="salesTableBody">
                      <tr>
                        <td colspan="5" style="text-align:center;padding:1.4rem;color:#666">No hay productos en el carrito</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
<div class="payment-grid">

  <div class="payment-item">
    <div class="payment-label">Cobrado</div>
    <div class="payment-value">Bs <span id="chargedAmount">0</span></div>
    <input type="number" id="paidAmount" class="payment-input" placeholder="0.00" step="0.01">
  </div>
  <div class="payment-item">
    <div class="payment-label">Cambio</div>
    <div class="payment-value">Bs <span id="changeAmount">0</span></div>
  </div>
    <div class="payment-item">
    <div class="payment-label">Total</div>
    <div class="payment-value" id="totalDisplay">Bs 0</div>
  </div>
</div>
<div class="action-buttons">
  <button class="btn btn-secondary" onclick="clearCart()">Limpiar</button>
  <button class="btn btn-success" id="processBtn" onclick="processSale()" disabled>Registrar Venta (F8)</button>
</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
// ===== VARIABLES GLOBALES =====
let cart = [];
let products = [];
let categories = [];
let currentUser = null;
const API_BASE = '/api';
let authToken = localStorage.getItem('pos_token');

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initPOS, 100);
});

async function initPOS() {
  try {
    await checkPrinterStatus();
    await Promise.all([loadCategories(), loadProducts()]);
    setupPOSEventListeners();
    
    // Agregar indicadores de teclado despu√©s de un momento
    setTimeout(() => {
      addKeyboardIndicators();
    }, 1500);
    
  } catch (e) {
    console.error('Error inicializando POS:', e);
    alert('Error inicializando POS');
  }
}

// ===== CATEGOR√çAS =====
async function loadCategories() {
  try {
    const response = await fetch(`${API_BASE}/categories`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    const data = await response.json();
    categories = data.categories || [];
    renderCategories();
  } catch (error) {
    console.error('Error cargando categor√≠as:', error);
  }
}

function renderCategories() {
  const nav = document.getElementById('categoriesNav');
  nav.innerHTML = '<button class="tab-btn active" data-category="all">Todos</button>';
  
  categories.forEach((category) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.dataset.category = category.id;
    btn.textContent = category.name;
    nav.appendChild(btn);
  });
}

// ===== PRODUCTOS =====
async function loadProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '<div style="text-align:center;color:#666;padding:1.6rem">Cargando productos...</div>';
  
  try {
    const response = await fetch(`${API_BASE}/products`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    const data = await response.json();
    products = data.products || [];
    renderProducts();
  } catch (error) {
    console.error('Error cargando productos:', error);
    grid.innerHTML = `
      <div style="text-align:center;color:red;padding:1.6rem">
        <div>Error cargando productos</div>
        <div style="font-size:0.8rem;margin-top:0.5rem">${error.message}</div>
        <button onclick="loadProducts()" style="margin-top:0.5rem;padding:0.5rem 1rem;border:1px solid #ccc;border-radius:4px;background:white;cursor:pointer;">Reintentar</button>
      </div>
    `;
  }
}

function renderProducts(list = products) {
  const grid = document.getElementById('productsGrid');
  
  if (!list.length) {
    grid.innerHTML = '<div style="text-align:center;color:#666;padding:1.6rem">No se encontraron productos</div>';
    return;
  }

  grid.innerHTML = list.map(product => `
    <div class="product-card" onclick="addToCart(${product.id})" data-category="${product.category_id}">
      <div class="product-image">
        ${product.image_url ? 
          `<img src="${product.image_url}" alt="${product.name}" 
               style="width:100%;height:100%;object-fit:cover;border-radius:12px;" 
               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:2rem;color:#ff7043;">üçΩÔ∏è</div>` :
          `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#ff7043;">üçΩÔ∏è</div>`
        }
      </div>
      <div class="product-name">${product.name}</div>
      <div class="product-price">Bs ${parseInt(product.price)}</div>
    </div>
  `).join('');
}

// ===== CARRITO =====
function addToCart(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  const existingItem = cart.find(item => item.product_id === productId);
  
  if (existingItem) {
    existingItem.quantity++;
  } else {
    cart.push({
      product_id: productId,
      product_name: product.name,
      unit_price: product.price,
      quantity: 1
    });
  }

  renderCart();
}

function renderCart() {
  const tbody = document.getElementById('salesTableBody');
  
  if (!cart.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:1.2rem;color:#666">No hay productos en el carrito</td></tr>';
    updateTotals();
    return;
  }

  tbody.innerHTML = cart.map((item, index) => `
    <tr>
      <td>
        <button class="btn btn-secondary" onclick="removeFromCart(${index})" 
                style="padding:.3rem .5rem">‚úï</button>
      </td>
      <td style="text-align:left">${item.product_name}</td>
      <td>Bs ${parseInt(item.unit_price)}</td>
      <td>
        <input type="number" min="1" value="${item.quantity}" 
               class="payment-input" style="max-width:70px" 
               onchange="updateQuantity(${index}, this.value)">
      </td>
      <td><strong>Bs ${parseInt(item.unit_price * item.quantity)}</strong></td>
    </tr>
  `).join('');

  updateTotals();
}

function updateQuantity(index, value) {
  const quantity = Math.max(1, parseInt(value));
  cart[index].quantity = quantity;
  renderCart();
}

function removeFromCart(index) {
  cart.splice(index, 1);
  renderCart();
}

function clearCart() {
  cart = [];
  renderCart();
  clearSale();
}

// ===== TOTALES Y PAGO - MEJORADO =====
function updateTotals() {
  const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
  
  // Actualizar el total en la columna correspondiente
  const totalDisplay = document.getElementById('totalDisplay');
  if (totalDisplay) {
    totalDisplay.textContent = `Bs ${parseInt(total)}`;
  }
  
  updatePaymentDisplay();
}

function updatePaymentDisplay() {
  const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
  const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
  const change = paid - total;
  
  // Actualizar cobrado
  const chargedAmount = document.getElementById('chargedAmount');
  if (chargedAmount) {
    chargedAmount.textContent = parseInt(paid);
  }
  
  // Actualizar cambio
  const changeAmount = document.getElementById('changeAmount');
  if (changeAmount) {
    if (paid > 0 && paid >= total) {
      changeAmount.textContent = parseInt(change);
      changeAmount.style.color = '#28a745';
    } else if (paid > 0 && paid < total) {
      changeAmount.textContent = `-${parseInt(Math.abs(change))}`;
      changeAmount.style.color = '#dc3545';
    } else {
      changeAmount.textContent = '0';
      changeAmount.style.color = '#1a1d29';
    }
  }
  
  // Habilitar/deshabilitar bot√≥n
  const processBtn = document.getElementById('processBtn');
  if (processBtn) {
    processBtn.disabled = !(paid >= total && cart.length > 0 && total > 0);
  }
}

function autoCompletePay() {
  const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
  if (total > 0) {
    document.getElementById('paidAmount').value = Math.ceil(total);
    updatePaymentDisplay();
  }
}

// ===== FUNCI√ìN PARA CIERRE DE CAJA (F3) =====
async function printDailyCashClose() {
  try {
    // Mostrar indicador visual
    const topBar = document.querySelector('.top-bar');
    if (topBar) {
      topBar.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
      topBar.style.color = 'white';
      topBar.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        topBar.style.background = 'white';
        topBar.style.color = '#1a1d29';
      }, 2500);
    }

    // Obtener el reporte del d√≠a actual
    const today = new Date().toISOString().split('T')[0];
    
    console.log('üìä Generando reporte de cierre de caja para:', today);
    
    // Mostrar indicador de carga
    showLoadingIndicator('Generando reporte de cierre...');
    
    const response = await fetch(`${API_BASE}/reports/daily?date=${today}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    hideLoadingIndicator();

    if (!response.ok) {
      throw new Error('Error obteniendo reporte diario');
    }

    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.message || 'Error en el reporte');
    }

    const report = data.report;

    // PREGUNTA √öNICA Y DIRECTA
    const shouldPrint = confirm('¬øDesea imprimir su cierre de caja?');
    
    if (!shouldPrint) {
      console.log('‚ùå Usuario cancel√≥ la impresi√≥n del cierre de caja');
      return;
    }

    // Preparar datos para impresi√≥n
    const printData = {
      type: 'daily_close',
      date: today,
      user: getCurrentUser(),
      user_name: getCurrentUser()?.full_name || 'Sistema',
      summary: report.summary,
      sales_by_user: report.sales_by_user || [],
      top_products: report.top_products || [],
      hourly_breakdown: report.hourly_breakdown || [],
      detailed_sales: report.detailed_sales || [],
      total_sales: report.summary?.total_sales || 0,
      total_amount: report.summary?.total_amount || 0,
      average_sale: report.summary?.average_sale || 0
    };

    // Enviar a imprimir
    showLoadingIndicator('Enviando a impresora...');
    await printDailyReport(printData);
    hideLoadingIndicator();

  } catch (error) {
    hideLoadingIndicator();
    console.error('‚ùå Error en cierre de caja:', error);
    
    alert(`‚ùå Error generando reporte de cierre:

${error.message}

Verifica:
‚Ä¢ Conexi√≥n de la impresora
‚Ä¢ Estado del servidor
‚Ä¢ Permisos de usuario`);
  }
}

// ===== FUNCI√ìN PARA IMPRIMIR REPORTE DIARIO =====
async function printDailyReport(reportData) {
  try {
    console.log('üñ®Ô∏è Enviando reporte diario a impresora...', reportData.date);

    const response = await fetch(`${API_BASE}/printer/daily-report`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ report_data: reportData })
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.message || 'Error enviando a impresora');
    }

    console.log('‚úÖ Reporte enviado a impresora correctamente');
    
    return {
      success: true,
      message: 'Reporte de cierre impreso correctamente'
    };

  } catch (error) {
    console.error('‚ùå Error imprimiendo reporte:', error);
    
    // Si falla la impresi√≥n, mostrar el reporte en pantalla
    showReportPreview(reportData);
    
    throw new Error(`Error de impresi√≥n: ${error.message}`);
  }
}

// ===== FUNCI√ìN PARA MOSTRAR VISTA PREVIA DEL REPORTE =====
function showReportPreview(reportData) {
  const summary = reportData.summary || {};
  const topProducts = reportData.top_products || [];
  const salesByUser = reportData.sales_by_user || [];
  
  let productsList = '';
  if (topProducts.length > 0) {
    productsList = topProducts.slice(0, 5).map((product, index) => 
      `${index + 1}. ${product.product_name || product.name} - ${product.total_quantity || product.quantity} vendidos`
    ).join('\n');
  } else {
    productsList = 'No hay productos vendidos';
  }

  let usersList = '';
  if (salesByUser.length > 0) {
    usersList = salesByUser.map((user, index) => 
      `${index + 1}. ${user.user_name || user.full_name} - ${user.total_sales || user.count} ventas`
    ).join('\n');
  } else {
    usersList = 'Un solo usuario';
  }
  
  const previewContent = `‚ïê‚ïê‚ïê VISTA PREVIA DEL REPORTE ‚ïê‚ïê‚ïê

üìÖ FECHA: ${reportData.date}
üë§ USUARIO: ${reportData.user?.full_name || reportData.user_name || 'Sistema'}

üìä RESUMEN DEL D√çA:
‚Ä¢ Total de ventas: ${reportData.total_sales || summary.total_sales || 0}
‚Ä¢ Monto total: Bs ${parseInt(reportData.total_amount || summary.total_amount || 0)}
‚Ä¢ Venta promedio: Bs ${parseInt(reportData.average_sale || summary.average_sale || 0)}

üèÜ TOP PRODUCTOS:
${productsList}

üë• VENTAS POR USUARIO:
${usersList}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
  
  alert(previewContent);
}

// ===== FUNCI√ìN PARA OBTENER USUARIO ACTUAL =====
function getCurrentUser() {
  try {
    const userData = localStorage.getItem('pos_user');
    if (userData) {
      return JSON.parse(userData);
    }
    
    // Si no hay usuario en localStorage, intentar extraer del token
    const token = localStorage.getItem('pos_token');
    if (token) {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return {
          id: payload.id,
          username: payload.username,
          full_name: payload.full_name || payload.username,
          role: payload.role
        };
      } catch (e) {
        console.warn('Error extrayendo usuario del token');
      }
    }
    
    return {
      id: 1,
      username: 'sistema',
      full_name: 'Sistema POS',
      role: 'admin'
    };
  } catch (error) {
    console.error('Error obteniendo usuario actual:', error);
    return {
      id: 1,
      username: 'sistema',
      full_name: 'Sistema POS',
      role: 'admin'
    };
  }
}

// ===== FUNCIONES DE UI AUXILIARES =====
function showLoadingIndicator(message = 'Procesando...') {
  // Eliminar indicador existente si existe
  hideLoadingIndicator();
  
  const indicator = document.createElement('div');
  indicator.id = 'loading-indicator';
  indicator.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
  `;
  
  indicator.innerHTML = `
    <div style="text-align: center; padding: 2rem;">
      <div style="margin-bottom: 1rem;">‚è≥</div>
      <div>${message}</div>
      <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
        Presiona ESC para cancelar
      </div>
    </div>
  `;
  
  document.body.appendChild(indicator);
  
  // Permitir cancelar con ESC
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      hideLoadingIndicator();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function hideLoadingIndicator() {
  const indicator = document.getElementById('loading-indicator');
  if (indicator) {
    indicator.remove();
  }
}

function showSuccessMessage(message) {
  alert(`‚úÖ ${message}`);
}

function showErrorMessage(message) {
  alert(`‚ùå ${message}`);
}

// ===== FUNCI√ìN AUXILIAR PARA MOSTRAR ATAJOS DE TECLADO =====
function showKeyboardShortcuts() {
  const shortcuts = `üîß ATAJOS DE TECLADO DISPONIBLES:

F3  üßæ - Cierre de Caja (Imprimir reporte del d√≠a)
F8  üí≥ - Venta R√°pida (Completar venta actual)
ESC üö´ - Cancelar operaci√≥n actual

üìã FUNCIONES ADICIONALES:
‚Ä¢ Ctrl+L - Limpiar carrito
‚Ä¢ Ctrl+P - Auto-completar pago`;
  
  alert(shortcuts);
}

// ===== AGREGAR INDICADOR VISUAL EN LA INTERFAZ =====
function addKeyboardIndicators() {
  // Verificar si ya existe
  if (document.getElementById('keyboard-hints')) return;
  
  const hintsElement = document.createElement('div');
  hintsElement.id = 'keyboard-hints';
  hintsElement.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 11px;
    z-index: 1001;
    font-family: 'Courier New', monospace;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
  `;
  
  hintsElement.innerHTML = `
    <div style="text-align: center;">
      <div style="font-weight: bold; margin-bottom: 4px;">‚å®Ô∏è ATAJOS</div>
      <div>F3: Cierre | F8: Venta</div>
      <div style="font-size: 9px; margin-top: 4px; opacity: 0.8;">Click para m√°s info</div>
    </div>
  `;
  
  // Agregar evento click para mostrar todos los atajos
  hintsElement.addEventListener('click', showKeyboardShortcuts);
  
  // Agregar hover effect
  hintsElement.addEventListener('mouseenter', () => {
    hintsElement.style.transform = 'scale(1.05)';
    hintsElement.style.background = 'rgba(255, 112, 67, 0.9)';
  });
  
  hintsElement.addEventListener('mouseleave', () => {
    hintsElement.style.transform = 'scale(1)';
    hintsElement.style.background = 'rgba(0, 0, 0, 0.85)';
  });
  
  document.body.appendChild(hintsElement);
}

// ===== EVENT LISTENERS ACTUALIZADOS =====
function setupPOSEventListeners() {
  const paidInput = document.getElementById('paidAmount');
  if (paidInput) {
    paidInput.addEventListener('input', updatePaymentDisplay);
  }

  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab-btn')) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      
      const category = e.target.dataset.category;
      if (category === 'all') {
        renderProducts(products);
      } else {
        renderProducts(products.filter(p => p.category_id == category));
      }
    }
  });

  // ===== EVENTOS DE TECLADO ACTUALIZADOS =====
  document.addEventListener('keydown', (e) => {
    // F3 - CIERRE DE CAJA
    if (e.key === 'F3') {
      e.preventDefault();
      console.log('üîë F3 presionado - Iniciando cierre de caja');
      
      // Efecto visual inmediato
      const topBar = document.querySelector('.top-bar');
      if (topBar) {
        topBar.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
        topBar.style.color = 'white';
      }
      
      printDailyCashClose();
    }
    
    // F8 - VENTA R√ÅPIDA (mantener funcionalidad existente)
    if (e.key === 'F8') {
      e.preventDefault();
      
      const topBar = document.querySelector('.top-bar');
      if (topBar) {
        topBar.style.background = 'linear-gradient(135deg,#28a745,#20c997)';
        topBar.style.color = 'white';
        setTimeout(() => {
          topBar.style.background = 'white';
          topBar.style.color = '#1a1d29';
        }, 1500);
      }
      
      ventaRapidaF8();
    }

    // ESC - LIMPIAR CARRITO
    if (e.key === 'Escape') {
      e.preventDefault();
      if (confirm('¬øLimpiar carrito actual?')) {
        clearCart();
      }
    }

    // CTRL+L - LIMPIAR CARRITO
    if (e.ctrlKey && e.key === 'l') {
      e.preventDefault();
      clearCart();
    }

    // CTRL+P - AUTO COMPLETAR PAGO
    if (e.ctrlKey && e.key === 'p') {
      e.preventDefault();
      autoCompletePay();
    }
  });
}

// ===== PROCESAMIENTO DE VENTAS =====
async function processSale() {
  if (!cart.length) {
    alert('El carrito est√° vac√≠o');
    return;
  }

  const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
  const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

  // Validaci√≥n mejorada
  if (paid === 0) {
    const confirm = window.confirm('No ingres√≥ monto. ¬øVenta sin pago registrado?');
    if (!confirm) return;
  } else if (paid < total) {
    alert(`Falta: Bs ${Math.round(total - paid)}`);
    return;
  }

  const saleData = {
    customer_nit: document.getElementById('customerNit').value || '1234',
    customer_name: document.getElementById('customerName').value || 'SIN NOMBRE',
    order_type: document.getElementById('orderType').value,
    payment_type: document.getElementById('paymentType').value,
    observations: document.getElementById('observations').value || '',
    total: total,
    paid_amount: paid,
    change_amount: paid - total,
    items: cart.map(item => ({
      product_id: item.product_id,
      quantity: item.quantity,
      unit_price: item.unit_price,
      total_price: item.unit_price * item.quantity
    }))
  };

  try {
    const response = await fetch(`${API_BASE}/sales`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(saleData)
    });

    const result = await response.json();

    if (response.ok && result.success) {
      clearCart();
      await printSaleTicketAuto(result.sale);
    } else {
      throw new Error(result.message || 'Error procesando venta');
    }

  } catch (error) {
    console.error('Error procesando venta:', error);
    alert(`Error procesando venta: ${error.message}`);
  }
}

async function ventaRapidaF8() {
  if (!cart.length) {
    alert('Carrito vac√≠o');
    return;
  }

  const paidInput = document.getElementById('paidAmount');
  if (!paidInput.value) {
    const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
    paidInput.value = Math.ceil(total);
    updatePaymentDisplay();
  }

  await processSale();
}

// ===== UTILIDADES =====
function clearSale() {
  const customerNit = document.getElementById('customerNit');
  const customerName = document.getElementById('customerName');
  const orderType = document.getElementById('orderType');
  const paymentType = document.getElementById('paymentType');
  const observations = document.getElementById('observations');
  const paidAmount = document.getElementById('paidAmount');
  
  if (customerNit) customerNit.value = '1234';
  if (customerName) customerName.value = 'SIN NOMBRE';
  if (orderType) orderType.value = 'dine_in';
  if (paymentType) paymentType.value = 'efectivo';
  if (observations) observations.value = '';
  if (paidAmount) paidAmount.value = '';
  
  // Limpiar tambi√©n los valores de cobrado y cambio
  const chargedAmount = document.getElementById('chargedAmount');
  const changeAmount = document.getElementById('changeAmount');
  
  if (chargedAmount) chargedAmount.textContent = '0';
  if (changeAmount) changeAmount.textContent = '0';
}

async function checkPrinterStatus() {
  try {
    const response = await fetch(`${API_BASE}/printer/status`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    await response.json();
  } catch (error) {
    // Ignorar errores de impresora
  }
}

async function printSaleTicketAuto(sale) {
  try {
    const response = await fetch(`${API_BASE}/printer/print-sale`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ sale_data: sale })
    });

    const result = await response.json();
    // No mostrar errores de impresi√≥n para no interrumpir flujo
  } catch (error) {
    // Ignorar errores de impresi√≥n
  }
}

function logout() {
  if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
    localStorage.removeItem('pos_token');
    localStorage.removeItem('pos_user');
    location.href = '/login';
  }
}

window.appLogout = logout;
  </script>

  <!-- Cargar sidebar universal -->
  <script src="/js/sidebar.js" defer></script>
</body>
</html>